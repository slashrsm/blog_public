<?xml version="1.0" encoding="utf-8"?>
<rss xmlns:dc="https://purl.org/dc/elements/1.1/" xmlns:content="https://purl.org/rss/1.0/modules/content/" xmlns:foaf="https://xmlns.com/foaf/0.1/" xmlns:og="https://ogp.me/ns#" xmlns:rdfs="https://www.w3.org/2000/01/rdf-schema#" xmlns:schema="https://schema.org/" xmlns:sioc="https://rdfs.org/sioc/ns#" xmlns:sioct="https://rdfs.org/sioc/types#" xmlns:skos="https://www.w3.org/2004/02/skos/core#" xmlns:xsd="https://www.w3.org/2001/XMLSchema#" version="2.0" xml:base="https://janezurevc.name/">
  <channel>
    <title>Varnish</title>
    <link>https://janezurevc.name/</link>
    <description/>
    <language>en</language>
    
    <item>
  <title>How to get client's IP number to Drupal when using Varnish</title>
  <link>https://janezurevc.name/how-get-clients-ip-number-drupal-when-using-varnish</link>
  <description>
&lt;span&gt;How to get client's IP number to Drupal when using Varnish&lt;/span&gt;

&lt;span&gt;&lt;span lang="" about="https://janezurevc.name/users/slashrsm" typeof="schema:Person" property="schema:name" datatype="" xml:lang=""&gt;slashrsm&lt;/span&gt;&lt;/span&gt;

&lt;span&gt;Wed, 07.12.2011 - 00:50&lt;/span&gt;

            &lt;div class="field field--name-body field--type-text-with-summary field--label-hidden field--item"&gt;&lt;p&gt;There are a lot of places, where you need client's IP address in &lt;a href="https://drupal.org"&gt;Drupal&lt;/a&gt; (or any other CMS/web app of course). The problem arises, when you use a &lt;a href="https://en.wikipedia.org/wiki/Reverse_proxy"&gt;reverse proxy server&lt;/a&gt; (like &lt;a href="https://varnish-cache.org"&gt;Varnish&lt;/a&gt;), since every request to web server will be done by the latter. We will have every single visitor of our website coming from a single IP (reverse proxy), as a result.&lt;/p&gt;
&lt;p&gt;Drupal is smart enough to overcome that. Reverse proxy servers can be configured to forward original client IP in a request header (usually &lt;em&gt;X-Forwarded-For&lt;/em&gt;). This value can be used on web server to know where our visitory come from. In Drupal we have function &lt;a href="https://api.drupal.org/api/drupal/includes--bootstrap.inc/function/ip_address/7"&gt;&lt;em&gt;ip_address()&lt;/em&gt;&lt;/a&gt;, which will read and return client's IP. If we take a look at this function's code, we can see that it already has support for situations, where reverse proxy is used. This function will still return Varnish's IP address by default, though.&lt;/p&gt;
&lt;p&gt;To make things working as we expected, we have to configure at least two variables in &lt;em&gt;settings.php&lt;/em&gt;:&lt;/p&gt;
&lt;pre&gt;
// Tell Drupal that we are behind a reverse proxy server
$conf['reverse_proxy'] = TRUE;

// List of trusted IPs (IP numbers of our reverse proxies)
$conf['reverse_proxy_addresses'] = array(
  '127.0.0.1',
);
&lt;/pre&gt;&lt;p&gt;That's it. Now &lt;em&gt;ip_address()&lt;/em&gt; returns IP number that was sent via request header. There is also a possibility to use custom header name:&lt;/p&gt;
&lt;pre&gt;
// Drupal will look for IP in $_SERVER['HTTP_MY_CUSTOM_HEADER']
$conf['reverse_proxy_header'] = 'HTTP_MY_CUSTOM_HEADER';
&lt;/pre&gt;&lt;/div&gt;
      </description>
  <pubDate>Tue, 06 Dec 2011 23:50:39 +0000</pubDate>
    <dc:creator>slashrsm</dc:creator>
    <guid isPermaLink="false">30 at https://janezurevc.name</guid>
    </item>

  </channel>
</rss>
